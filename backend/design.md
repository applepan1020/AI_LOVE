# 后端设计文档

## 一、架构设计

### 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (Next.js) │    │   后端 (Node.js) │    │   数据库/缓存    │
│                 │◄──►│                 │◄──►│                 │
│  - 首页展示      │    │  - API 服务      │    │  - MongoDB      │
│  - 测试界面      │    │  - 业务逻辑      │    │  - Redis        │
│  - 结果展示      │    │  - AI 集成      │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 分层架构
- **表现层**: Express.js 路由和中间件
- **业务层**: 服务层 (Services)
- **数据层**: 数据访问层 (DAO/Repository)
- **基础设施层**: 数据库、缓存、外部API

## 二、技术选型

### 核心技术栈
- **运行环境**: Node.js 18+
- **Web框架**: Express.js 4.x
- **数据库**: MongoDB 6.x (主数据库)
- **缓存**: Redis 7.x (会话和缓存)
- **认证**: JWT + bcrypt
- **API文档**: Swagger/OpenAPI 3.0
- **日志**: Winston
- **测试**: Jest + Supertest

### 开发工具
- **包管理**: npm
- **代码规范**: ESLint + Prettier
- **类型检查**: TypeScript
- **进程管理**: PM2
- **容器化**: Docker

## 三、接口规范

### RESTful API 设计
- **基础URL**: `/api/v1`
- **认证方式**: Bearer Token (JWT)
- **响应格式**: JSON
- **状态码**: 标准HTTP状态码

### 接口分类
1. **用户管理**: `/api/v1/users`
2. **测试系统**: `/api/v1/tests`
3. **分析报告**: `/api/v1/reports`
4. **历史记录**: `/api/v1/history`

### 响应格式标准
```json
{
  "success": true,
  "data": {},
  "message": "操作成功",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

## 四、数据库设计

### MongoDB 集合设计
1. **users**: 用户信息
2. **tests**: 测试记录
3. **questions**: 问卷题目
4. **reports**: 分析报告
5. **sessions**: 会话信息

### Redis 键设计
- `session:{userId}`: 用户会话
- `cache:test:{testId}`: 测试缓存
- `rate:limit:{ip}`: 限流计数

## 五、安全与权限

### 安全措施
- **密码加密**: bcrypt (salt rounds: 12)
- **JWT签名**: 强密钥 + 过期时间
- **CORS配置**: 限制跨域访问
- **输入验证**: Joi/Yup 数据验证
- **SQL注入防护**: MongoDB 原生查询
- **XSS防护**: 输入输出过滤

### 权限控制
- **匿名用户**: 基础测试功能
- **注册用户**: 完整功能 + 历史记录
- **管理员**: 数据管理和系统配置

## 六、性能与扩展性

### 性能优化
- **数据库索引**: 关键字段建立索引
- **缓存策略**: Redis 缓存热点数据
- **分页查询**: 大数据集分页处理
- **连接池**: MongoDB 连接池管理

### 扩展性设计
- **微服务架构**: 模块化设计，便于拆分
- **负载均衡**: 支持多实例部署
- **消息队列**: 异步任务处理
- **监控告警**: 系统监控和性能指标

---

> 本文档将持续更新，反映最新的架构设计和技术决策。 